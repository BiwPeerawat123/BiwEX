<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Periodic Table - Web Version</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #ffffff; 
            touch-action: none;
        }
        
        #info {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #333333; 
            font-family: 'Sarabun', sans-serif;
            pointer-events: none;
            z-index: 10;
            font-size: clamp(14px, 4vw, 18px);
            font-weight: bold;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .ar-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: clamp(8px, 2vw, 12px) clamp(15px, 3vw, 25px);
            font-size: clamp(14px, 3vw, 18px);
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            pointer-events: auto;
            touch-action: manipulation;
        }

        .ar-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .ar-btn.active {
            background-color: #27ae60;
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);
        }

        #arStatus {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        canvas { display: block; }
        
        @media (max-width: 768px) {
            #container { height: 100vh; }
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>

<body>

<div id="info">คลิกที่ธาตุเพื่อดูรายละเอียด | หมุน/ซูม เพื่อดูรอบๆ</div>
<div id="container"></div>
<button class="ar-btn" id="arBtn">AR</button>
<div id="arStatus"></div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const categories = {
    "alkaline-earth": { color: "#FFD700" },
    "post-transition": { color: "#FFB6C1" },
    "metalloid": { color: "#D8BFD8" },
    "nonmetal": { color: "#FF69B4" },
    "transition": { color: "#9370DB" }
};

const table = [
    ["C","6",1,1,"nonmetal","c.html"],
    ["Mg","12",2,1,"alkaline-earth","mg.html"],
    ["Al","13",3,1,"post-transition","ai.html"],
    ["Si","14",4,1,"metalloid","si.html"],
    ["P","15",1,2,"nonmetal","p.html"],
    ["S","16",2,2,"nonmetal","s.html"],
    ["Fe","26",3,2,"transition",""],
    ["Cu","29",4,2,"transition",""],
    ["Zn","30",1,3,"transition",""],
    ["Ag","47",2,3,"transition",""],
    ["W","74",3,3,"transition",""],
    ["Au","79",4,3,"transition",""]
];

let camera, scene, renderer, controls;
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let arModeEnabled = false;
let hasParent = window.parent !== window;

// Elements
const arBtn = document.getElementById('arBtn');
const arStatus = document.getElementById('arStatus');

// ตรวจสอบว่ารองรับ WebXR หรือไม่
const isARSupported = async () => {
    if (!navigator.xr) return false;
    try {
        const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
        return isSupported;
    } catch (e) {
        return false;
    }
};

init();
animate();

async function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    // ปรับ FOV ตามขนาดจอ
    const isMobile = window.innerWidth < 768;
    camera = new THREE.PerspectiveCamera(
        isMobile ? 60 : 45, 
        window.innerWidth / window.innerHeight, 
        1, 5000
    );
    camera.position.set(0, 0, isMobile ? 1500 : 2000);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(200, 300, 400);
    scene.add(light);

    // ปรับขนาดกล่องตามจอ
    const scale = isMobile ? 0.7 : 1;
    const boxGeo = new THREE.BoxGeometry(140 * scale, 180 * scale, 40 * scale);

    table.forEach(([sym, num, col, row, type, url]) => {
        const color = categories[type].color;
        const tex = createTextTexture(sym, num, color, scale);

        const front = new THREE.MeshStandardMaterial({ map: tex });
        const side = new THREE.MeshStandardMaterial({ color });

        const cube = new THREE.Mesh(boxGeo, [side, side, side, side, front, side]);
        cube.position.set(
            col * 200 * scale - 500 * scale, 
            -(row * 220 * scale) + 350 * scale, 
            0
        );
        cube.userData = { URL: url, isElement: true, symbol: sym };
        scene.add(cube);
    });

    // ปรับขนาด backboard
    createBackboard(scale);
    await createTitleText(scale);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('container').appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // รับข้อความจาก parent
    if (hasParent) {
        window.addEventListener('message', (event) => {
            if (event.data.type === 'AR_MODE_CHANGED') {
                arModeEnabled = event.data.enabled;
                updateARButtonUI();
                updateInfoText();
            }
        });
    }

    // เพิ่ม event listener สำหรับปุ่ม AR
    arBtn.addEventListener('click', toggleAR);

    window.addEventListener('resize', onResize);
    
    // รองรับ touch events
    renderer.domElement.addEventListener('click', onClick);
    renderer.domElement.addEventListener('mousemove', onHover);
    renderer.domElement.addEventListener('touchstart', onTouch, { passive: false });
}

function createBackboard(scale = 1) {
    const geo = new THREE.BoxGeometry(1000 * scale, 1100 * scale, 20 * scale);
    const mat = new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.9 });
    const board = new THREE.Mesh(geo, mat);
    board.position.set(0, -150 * scale, -40 * scale);
    scene.add(board);
}

async function createTitleText(scale = 1) {
    const canvas = document.createElement('canvas');
    const size = Math.floor(1024 * scale);
    canvas.width = size;
    canvas.height = Math.floor(256 * scale);
    const ctx = canvas.getContext('2d');

    // ฟอนต์ responsive
    const fontSize = Math.floor(120 * scale);
    ctx.font = `bold ${fontSize}px Sarabun, Arial, sans-serif`;
    ctx.fillStyle = "#1a2035";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ตารางธาตุ", canvas.width / 2, canvas.height / 2);

    const tex = new THREE.CanvasTexture(canvas);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
    const mesh = new THREE.Mesh(
        new THREE.PlaneGeometry(700 * scale, 170 * scale), 
        mat
    );
    mesh.position.set(0, 430 * scale, 5 * scale);
    scene.add(mesh);
}

function createTextTexture(symbol, number, color, scale = 1) {
    const c = document.createElement('canvas');
    const width = Math.floor(256 * scale);
    const height = Math.floor(330 * scale);
    c.width = width;
    c.height = height;
    const ctx = c.getContext('2d');

    ctx.fillStyle = color;
    ctx.fillRect(0, 0, c.width, c.height);

    // ฟอนต์ responsive
    const numberFontSize = Math.floor(42 * scale);
    ctx.font = `bold ${numberFontSize}px Arial, sans-serif`;
    ctx.fillStyle = "#000";
    ctx.fillText(number, 20 * scale, 50 * scale);

    const symbolFontSize = Math.floor(120 * scale);
    ctx.font = `bold ${symbolFontSize}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(symbol, c.width / 2, c.height / 2 + 10 * scale);

    return new THREE.CanvasTexture(c);
}

// เพิ่มฟังก์ชัน toggle AR
function toggleAR() {
    if (hasParent) {
        // ส่งข้อความไป parent
        window.parent.postMessage({
            type: 'TOGGLE_AR_MODE'
        }, '*');
    } else {
        // ใช้ WebXR API โดยตรง
        startWebXRAR();
    }
}

// เพิ่มฟังก์ชัน WebXR AR
async function startWebXRAR() {
    if (!navigator.xr) {
        showARStatus('เบราว์เซอร์นี้ไม่รองรับ WebXR');
        return;
    }

    try {
        const supported = await navigator.xr.isSessionSupported('immersive-ar');
        if (!supported) {
            showARStatus('อุปกรณ์นี้ไม่รองรับ AR');
            return;
        }

        arModeEnabled = !arModeEnabled;
        updateARButtonUI();
        updateInfoText();

        if (arModeEnabled) {
            showARStatus('กำลังเปิด AR โหมด...');
            // สามารถเพิ่มโค้ดสำหรับ AR session ได้ที่นี่
        } else {
            hideARStatus();
        }
    } catch (e) {
        showARStatus('เกิดข้อผิดพลาดในการเปิด AR');
        console.error(e);
    }
}

function showARStatus(message) {
    arStatus.textContent = message;
    arStatus.style.display = 'block';
    setTimeout(() => hideARStatus(), 3000);
}

function hideARStatus() {
    arStatus.style.display = 'none';
}

// เพิ่มฟังก์ชันอัปเดต UI ปุ่ม
function updateARButtonUI() {
    if (arModeEnabled) {
        arBtn.classList.add('active');
        arBtn.textContent = 'ปิด AR';
    } else {
        arBtn.classList.remove('active');
        arBtn.textContent = 'AR';
    }
}

// เพิ่มฟังก์ชันอัปเดตข้อความ info
function updateInfoText() {
    const info = document.getElementById('info');
    if (arModeEnabled) {
        info.textContent = 'คลิกที่ธาตุเพื่อเปิด AR | หมุน/ซูม เพื่อดูรอบๆ';
    } else {
        info.textContent = 'คลิกที่ธาตุเพื่อดูรายละเอียด | หมุน/ซูม เพื่อดูรอบๆ';
    }
}

function onClick(e) {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    
    if (hit.length && hit[0].object.userData.URL) {
        const elementUrl = hit[0].object.userData.URL;
        const elementName = elementUrl.replace('.html', '');
        
        if (arModeEnabled && hasParent) {
            window.parent.postMessage({
                type: 'ELEMENT_SELECTED_FOR_AR',
                element: elementName
            }, '*');
        } else {
            // เปิดลิงก์ในแท็บใหม่สำหรับมือถือ
            window.open(elementUrl, '_blank');
        }
    }
}

function onTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    
    if (hit.length && hit[0].object.userData.URL) {
        hit[0].object.material[4].color.set(0xffffff);
        setTimeout(() => {
            hit[0].object.material[4].color.set(0xffffff);
        }, 200);
        onClick(touch);
    }
}

function onHover(e) {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    document.body.style.cursor =
        hit.length && hit[0].object.userData.URL ? 'pointer' : 'default';
}

function onResize() {
    const isMobile = window.innerWidth < 768;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.fov = isMobile ? 60 : 45;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
</script>

</body>
</html>
