<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Periodic Table AR - ตารางธาตุแบบ AR</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            touch-action: none;
            font-family: 'Sarabun', sans-serif;
        }
        
        /* UI สำหรับโหมดปกติ */
        #normalUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }
        
        #info {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #333333; 
            font-family: 'Sarabun', sans-serif;
            pointer-events: none;
            z-index: 10;
            font-size: clamp(14px, 4vw, 18px);
            font-weight: bold;
            padding: 0 10px;
            box-sizing: border-box;
        }

        /* ปุ่ม AR - แสดงตลอดเวลา */
        .ar-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: clamp(8px, 2vw, 12px) clamp(15px, 3vw, 25px);
            font-size: clamp(14px, 3vw, 18px);
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            pointer-events: auto;
            touch-action: manipulation;
        }

        .ar-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .ar-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* AR UI */
        #arUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        #arAnnotation {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            pointer-events: auto;
            z-index: 200;
        }

        #arStatus {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }

        /* Canvas สำหรับ AR */
        #arCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        canvas { display: block; }
        
        @media (max-width: 768px) {
            #container { height: 100vh; }
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    </script>
</head>

<body>

<!-- UI สำหรับโหมดปกติ -->
<div id="normalUI">
    <div id="info">คลิกที่ธาตุเพื่อดูรายละเอียด | หรือกดปุ่ม AR เพื่อดูในโลกจริง</div>
    <div id="container"></div>
</div>

<!-- Canvas สำหรับ AR -->
<canvas id="arCanvas"></canvas>

<!-- UI สำหรับโหมด AR -->
<div id="arUI">
    <div id="arAnnotation">คลิกที่ธาตุใน AR เพื่อดูรายละเอียด</div>
    <div id="arStatus"></div>
</div>

<!-- ปุ่ม AR -->
<button class="ar-btn" id="arBtn">เปิด AR</button>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { ARButton } from 'three/addons/webxr/ARButton.js';

const categories = {
    "alkaline-earth": { color: "#FFD700" },
    "post-transition": { color: "#FFB6C1" },
    "metalloid": { color: "#D8BFD8" },
    "nonmetal": { color: "#FF69B4" },
    "transition": { color: "#9370DB" }
};

const table = [
    ["C","6",1,1,"nonmetal","c.html"],
    ["Mg","12",2,1,"alkaline-earth","mg.html"],
    ["Al","13",3,1,"post-transition","ai.html"],
    ["Si","14",4,1,"metalloid","si.html"],
    ["P","15",1,2,"nonmetal","p.html"],
    ["S","16",2,2,"nonmetal","s.html"],
    ["Fe","26",3,2,"transition",""],
    ["Cu","29",4,2,"transition",""],
    ["Zn","30",1,3,"transition",""],
    ["Ag","47",2,3,"transition",""],
    ["W","74",3,3,"transition",""],
    ["Au","79",4,3,"transition",""]
];

let scene, camera, renderer, controls;
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let arSession = null;
let arRenderer = null;
let selectedElement = null;

// UI Elements
const arBtn = document.getElementById('arBtn');
const arCanvas = document.getElementById('arCanvas');
const arAnnotation = document.getElementById('arAnnotation');
const arStatus = document.getElementById('arStatus');
const normalUI = document.getElementById('normalUI');
const arUI = document.getElementById('arUI');

init();
setupARButton();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const isMobile = window.innerWidth < 768;
    camera = new THREE.PerspectiveCamera(
        isMobile ? 60 : 45, 
        window.innerWidth / window.innerHeight, 
        0.1, 5000
    );
    camera.position.set(0, 0, isMobile ? 1500 : 2000);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.xr.enabled = true; // เปิดใช้ WebXR
    document.getElementById('container').appendChild(renderer.domElement);

    // สร้างตารางธาตุ
    const scale = isMobile ? 0.7 : 1;
    const boxGeo = new THREE.BoxGeometry(140 * scale, 180 * scale, 40 * scale);

    table.forEach(([sym, num, col, row, type, url]) => {
        const color = categories[type].color;
        const tex = createTextTexture(sym, num, color, scale);
        const front = new THREE.MeshStandardMaterial({ map: tex });
        const side = new THREE.MeshStandardMaterial({ color });
        const cube = new THREE.Mesh(boxGeo, [side, side, side, side, front, side]);
        cube.position.set(col * 200 * scale - 500 * scale, -(row * 220 * scale) + 350 * scale, 0);
        cube.userData = { URL: url, symbol: sym, isElement: true };
        scene.add(cube);
    });

    createBackboard(scale);
    createTitleText(scale);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    window.addEventListener('resize', onResize);
    renderer.domElement.addEventListener('click', onClick);
    renderer.domElement.addEventListener('mousemove', onHover);
    renderer.domElement.addEventListener('touchstart', onTouch, { passive: false });
}

function createBackboard(scale = 1) {
    const geo = new THREE.BoxGeometry(1000 * scale, 1100 * scale, 20 * scale);
    const mat = new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.9 });
    const board = new THREE.Mesh(geo, mat);
    board.position.set(0, -150 * scale, -40 * scale);
    scene.add(board);
}

function createTitleText(scale = 1) {
    const canvas = document.createElement('canvas');
    const size = Math.floor(1024 * scale);
    canvas.width = size;
    canvas.height = Math.floor(256 * scale);
    const ctx = canvas.getContext('2d');
    const fontSize = Math.floor(120 * scale);
    ctx.font = `bold ${fontSize}px Sarabun, Arial, sans-serif`;
    ctx.fillStyle = "#1a2035";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ตารางธาตุ", canvas.width / 2, canvas.height / 2);
    const tex = new THREE.CanvasTexture(canvas);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
    const mesh = new THREE.Mesh(new THREE.PlaneGeometry(700 * scale, 170 * scale), mat);
    mesh.position.set(0, 430 * scale, 5 * scale);
    scene.add(mesh);
}

function createTextTexture(symbol, number, color, scale = 1) {
    const c = document.createElement('canvas');
    const width = Math.floor(256 * scale);
    const height = Math.floor(330 * scale);
    c.width = width;
    c.height = height;
    const ctx = c.getContext('2d');
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, c.width, c.height);
    const numberFontSize = Math.floor(42 * scale);
    ctx.font = `bold ${numberFontSize}px Arial, sans-serif`;
    ctx.fillStyle = "#000";
    ctx.fillText(number, 20 * scale, 50 * scale);
    const symbolFontSize = Math.floor(120 * scale);
    ctx.font = `bold ${symbolFontSize}px Arial, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(symbol, c.width / 2, c.height / 2 + 10 * scale);
    return new THREE.CanvasTexture(c);
}

// ==================== AR Functions ====================

function setupARButton() {
    if ('xr' in navigator) {
        navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            if (supported) {
                arBtn.style.display = 'block';
                arBtn.onclick = () => startAR();
            } else {
                arBtn.textContent = 'AR ไม่รองรับ';
                arBtn.disabled = true;
                showARStatus('อุปกรณ์ไม่รองรับ AR');
            }
        }).catch(() => {
            arBtn.textContent = 'ตรวจสอบ AR ล้มเหลว';
            arBtn.disabled = true;
        });
    } else {
        arBtn.textContent = 'WebXR ไม่รองรับ';
        arBtn.disabled = true;
        showARStatus('เบราว์เซอร์ไม่รองรับ WebXR');
    }
}

async function startAR() {
    try {
        showARStatus('กำลังเปิด AR...');
        
        // ขอ AR session
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['hit-test', 'dom-overlay'],
            optionalFeatures: ['local-floor'],
            domOverlay: { root: document.body }
        });

        arSession = session;
        
        // ซ่อน UI ปกติ
        normalUI.style.display = 'none';
        arBtn.style.display = 'none';
        
        // แสดง UI AR
        arCanvas.style.display = 'block';
        arUI.style.display = 'block';
        arAnnotation.style.display = 'block';

        // สร้าง AR renderer
        arRenderer = new THREE.WebGLRenderer({
            canvas: arCanvas,
            antialias: true,
            alpha: true
        });
        arRenderer.setSize(window.innerWidth, window.innerHeight);
        arRenderer.setPixelRatio(window.devicePixelRatio);
        arRenderer.xr.enabled = true;
        arRenderer.xr.setReferenceSpaceType('local');
        arRenderer.xr.setSession(session);

        // เริ่ม render loop สำหรับ AR
        arRenderer.setAnimationLoop(renderAR);

        // เมื่อปิด AR
        session.addEventListener('end', () => {
            arSession = null;
            arCanvas.style.display = 'none';
            arUI.style.display = 'none';
            arAnnotation.style.display = 'none';
            arBtn.style.display = 'block';
            normalUI.style.display = 'block';
            arRenderer.setAnimationLoop(null);
            hideARStatus();
        });

        hideARStatus();

    } catch (err) {
        console.error('AR Error:', err);
        showARStatus('เปิด AR ล้มเหลว: ' + err.message);
        setTimeout(() => hideARStatus(), 3000);
    }
}

function renderAR() {
    if (!arRenderer || !arSession) return;
    
    // อัปเดตกล้อง AR
    if (arRenderer.xr.isPresenting) {
        const xrCamera = arRenderer.xr.getCamera(camera);
        
        // วางตารางธาตุตรงกลาง (1 เมตรหน้ากล้อง)
        scene.position.set(0, 0, -1);
        scene.quaternion.set(0, 0, 0, 1);
    }
    
    arRenderer.render(scene, camera);
}

function showARStatus(message) {
    arStatus.textContent = message;
    arStatus.style.display = 'block';
}

function hideARStatus() {
    arStatus.style.display = 'none';
}

// ==================== Event Handlers ====================

function onClick(e) {
    // ในโหมด AR ให้ตรวจจับการคลิกที่ธาตุ
    if (arSession) {
        // ใช้ raycaster กับกล้อง AR
        mouse.x = 0;
        mouse.y = 0;
        raycaster.setFromCamera(mouse, camera);
        const hit = raycaster.intersectObjects(scene.children);
        
        if (hit.length && hit[0].object.userData.URL) {
            const elementUrl = hit[0].object.userData.URL;
            arAnnotation.textContent = `เลือกธาตุ: ${hit[0].object.userData.symbol} - กำลังเปิดรายละเอียด...`;
            setTimeout(() => {
                window.open(elementUrl, '_blank');
            }, 500);
        }
        return;
    }

    // โหมดปกติ
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    
    if (hit.length && hit[0].object.userData.URL) {
        const elementUrl = hit[0].object.userData.URL;
        window.open(elementUrl, '_blank');
    }
}

function onTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    
    if (hit.length && hit[0].object.userData.URL) {
        hit[0].object.material[4].color.set(0xffffff);
        setTimeout(() => {
            hit[0].object.material[4].color.set(0xffffff);
        }, 200);
        onClick(touch);
    }
}

function onHover(e) {
    if (arSession) return; // ไม่ต้อง hover ในโหมด AR
    
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    document.body.style.cursor = hit.length && hit[0].object.userData.URL ? 'pointer' : 'default';
}

function onResize() {
    const isMobile = window.innerWidth < 768;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.fov = isMobile ? 60 : 45;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    
    if (arRenderer) {
        arRenderer.setSize(window.innerWidth, window.innerHeight);
    }
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    if (!arSession) {
        renderer.render(scene, camera);
    }
}
</script>

</body>
</html>
