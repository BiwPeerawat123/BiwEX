<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>3D Periodic Table - Web Version</title>

    <style>
        body { margin: 0; overflow: hidden; background-color: #ffffff; }
        
        #info {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            color: #333333; 
            font-family: 'Sarabun', sans-serif;
            pointer-events: none;
            z-index: 10;
            font-size: 18px;
            font-weight: bold;
        }

        /* เพิ่มสไตล์ปุ่ม AR */
        .ar-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 25px;
            font-size: 18px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            pointer-events: auto;
        }

        .ar-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .ar-btn.active {
            background-color: #27ae60;
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);
        }

        canvas { display: block; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js  ",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/  "
        }
    }
    </script>
</head>

<body>

<div id="info">คลิกที่ธาตุเพื่อดูรายละเอียด | หมุน/ซูม เพื่อดูรอบๆ</div>
<div id="container"></div>

<!-- เพิ่มปุ่ม AR -->
<button class="ar-btn" id="arBtn">AR</button>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const categories = {
    "alkaline-earth": { color: "#FFD700" },
    "post-transition": { color: "#FFB6C1" },
    "metalloid": { color: "#D8BFD8" },
    "nonmetal": { color: "#FF69B4" },
    "transition": { color: "#9370DB" }
};

const table = [
    ["C","6",1,1,"nonmetal","c.html"],
    ["Mg","12",2,1,"alkaline-earth","mg.html"],
    ["Al","13",3,1,"post-transition","ai.html"],
    ["Si","14",4,1,"metalloid","si.html"],
    ["P","15",1,2,"nonmetal","p.html"],
    ["S","16",2,2,"nonmetal","s.html"],
    ["Fe","26",3,2,"transition",""],
    ["Cu","29",4,2,"transition",""],
    ["Zn","30",1,3,"transition",""],
    ["Ag","47",2,3,"transition",""],
    ["W","74",3,3,"transition",""],
    ["Au","79",4,3,"transition",""]
];

let camera, scene, renderer, controls;
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let arModeEnabled = false;

// เพิ่มตัวแปรและ elements
const arBtn = document.getElementById('arBtn');

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 5000);
    camera.position.set(0, 0, 2000);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(200, 300, 400);
    scene.add(light);

    const boxGeo = new THREE.BoxGeometry(140, 180, 40);

    table.forEach(([sym, num, col, row, type, url]) => {
        const color = categories[type].color;
        const tex = createTextTexture(sym, num, color);

        const front = new THREE.MeshStandardMaterial({ map: tex });
        const side = new THREE.MeshStandardMaterial({ color });

        const cube = new THREE.Mesh(boxGeo, [side, side, side, side, front, side]);
        cube.position.set(col * 200 - 500, -(row * 220) + 350, 0);
        cube.userData = { URL: url, isElement: true };
        scene.add(cube);
    });

    createBackboard();
    createTitleText();

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('container').appendChild(renderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    
    // รับข้อความจาก parent
    window.addEventListener('message', (event) => {
        if (event.data.type === 'AR_MODE_CHANGED') {
            arModeEnabled = event.data.enabled;
            updateARButtonUI();
            updateInfoText();
        }
    });

    // เพิ่ม event listener สำหรับปุ่ม AR
    arBtn.addEventListener('click', toggleAR);

    window.addEventListener('resize', onResize);
    window.addEventListener('click', onClick);
    window.addEventListener('mousemove', onHover);
}

function createBackboard() {
    const geo = new THREE.BoxGeometry(1000, 1100, 20);
    const mat = new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.9 });
    const board = new THREE.Mesh(geo, mat);
    board.position.set(0, -150, -40);
    scene.add(board);
}

function createTitleText() {
    const canvas = document.createElement('canvas');
    canvas.width = 1024;
    canvas.height = 256;
    const ctx = canvas.getContext('2d');

    ctx.font = "bold 120px Sarabun, Arial";
    ctx.fillStyle = "#1a2035";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ตารางธาตุ", canvas.width / 2, canvas.height / 2);

    const tex = new THREE.CanvasTexture(canvas);
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
    const mesh = new THREE.Mesh(new THREE.PlaneGeometry(700, 170), mat);
    mesh.position.set(0, 430, 5);
    scene.add(mesh);
}

function createTextTexture(symbol, number, color) {
    const c = document.createElement('canvas');
    c.width = 256;
    c.height = 330;
    const ctx = c.getContext('2d');

    ctx.fillStyle = color;
    ctx.fillRect(0, 0, c.width, c.height);

    ctx.font = "bold 42px Arial";
    ctx.fillStyle = "#000";
    ctx.fillText(number, 20, 50);

    ctx.font = "bold 120px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(symbol, c.width / 2, c.height / 2 + 10);

    return new THREE.CanvasTexture(c);
}

// เพิ่มฟังก์ชัน toggle AR
function toggleAR() {
    // ส่งข้อความไป parent เพื่อสลับโหมด AR
    window.parent.postMessage({
        type: 'TOGGLE_AR_MODE'
    }, '*');
}

// เพิ่มฟังก์ชันอัปเดต UI ปุ่ม
function updateARButtonUI() {
    if (arModeEnabled) {
        arBtn.classList.add('active');
        arBtn.textContent = 'ปิด AR';
    } else {
        arBtn.classList.remove('active');
        arBtn.textContent = 'AR';
    }
}

// เพิ่มฟังก์ชันอัปเดตข้อความ info
function updateInfoText() {
    const info = document.getElementById('info');
    if (arModeEnabled) {
        info.textContent = 'คลิกที่ธาตุเพื่อเปิด AR | หมุน/ซูม เพื่อดูรอบๆ';
    } else {
        info.textContent = 'คลิกที่ธาตุเพื่อดูรายละเอียด | หมุน/ซูม เพื่อดูรอบๆ';
    }
}

function onClick(e) {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    
    if (hit.length && hit[0].object.userData.URL) {
        const elementUrl = hit[0].object.userData.URL;
        const elementName = elementUrl.replace('.html', '');
        
        if (arModeEnabled) {
            window.parent.postMessage({
                type: 'ELEMENT_SELECTED_FOR_AR',
                element: elementName
            }, '*');
        } else {
            window.location.href = elementUrl;
        }
    }
}

function onHover(e) {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hit = raycaster.intersectObjects(scene.children);
    document.body.style.cursor =
        hit.length && hit[0].object.userData.URL ? 'pointer' : 'default';
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
</script>

</body>
</html>
